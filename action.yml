name: 'NiFi Flow CI/CD'
description: 'CI/CD actions for Apache NiFi flows using nipyapi CLI'
author: 'Chaffelson'

inputs:
  command:
    description: 'Command: ensure-registry, deploy-flow, start-flow, stop-flow, cleanup, configure-params, get-status, change-version, revert-flow, purge-flowfiles'
    required: true

  # NiFi Connection
  nifi-api-endpoint:
    description: 'NiFi API endpoint URL'
    required: true
  nifi-username:
    description: 'NiFi username'
    required: false
    default: ''
  nifi-password:
    description: 'NiFi password'
    required: false
    default: ''
  nifi-bearer-token:
    description: 'NiFi bearer token (alternative to username/password)'
    required: false
    default: ''
  nifi-verify-ssl:
    description: 'Verify SSL certificates'
    required: false
    default: 'true'

  # Registry configuration
  registry-token:
    description: 'PAT for Git repository access (GitHub or GitLab)'
    required: false
    default: ''
  registry-repo:
    description: 'Repository in owner/repo format'
    required: false
    default: ''
  registry-client-name:
    description: 'Name for the registry client'
    required: false
    default: ''
  registry-client-id:
    description: 'ID of the registry client'
    required: false
    default: ''
  repository-path:
    description: 'Path within repository'
    required: false
    default: ''

  # Flow configuration
  bucket:
    description: 'Bucket containing the flow'
    required: false
    default: ''
  flow:
    description: 'Flow name'
    required: false
    default: ''
  branch:
    description: 'Branch to deploy from'
    required: false
    default: ''
  version:
    description: 'Version to deploy'
    required: false
    default: ''

  # Process group operations
  process-group-id:
    description: 'ID of the Process Group'
    required: false
    default: ''

  # Parameters
  parameters:
    description: 'JSON object of parameters'
    required: false
    default: ''

  # Logging control
  log-level:
    description: 'Log level: ERROR, WARNING (default), INFO, DEBUG'
    required: false
    default: 'WARNING'

  # Stop/Cleanup options (safe defaults - explicit opt-in for destructive operations)
  disable-controllers:
    description: 'Disable controller services (for stop-flow, needed before deletion)'
    required: false
    default: 'false'
  delete-parameter-context:
    description: 'Delete parameter context during cleanup (for CI/CD full cleanup)'
    required: false
    default: 'false'
  force:
    description: 'Force deletion even with queued FlowFiles'
    required: false
    default: 'false'

outputs:
  registry-client-id:
    description: 'ID of the registry client'
    value: ${{ steps.run.outputs.registry_client_id }}
  registry-client-name:
    description: 'Name of the registry client'
    value: ${{ steps.run.outputs.registry_client_name }}
  process-group-id:
    description: 'ID of the deployed Process Group'
    value: ${{ steps.run.outputs.process_group_id }}
  process-group-name:
    description: 'Name of the deployed Process Group'
    value: ${{ steps.run.outputs.process_group_name }}
  deployed-version:
    description: 'Version deployed'
    value: ${{ steps.run.outputs.deployed_version }}
  success:
    description: 'Whether the command succeeded'
    value: ${{ steps.run.outputs.success }}

runs:
  using: 'composite'
  steps:
    - name: Install nipyapi CLI
      shell: bash
      run: pip install -q "nipyapi[cli] @ git+https://github.com/Chaffelson/nipyapi.git@feature/cli"

    - name: Run command
      id: run
      shell: bash
      env:
        NIFI_API_ENDPOINT: ${{ inputs.nifi-api-endpoint }}
        NIFI_USERNAME: ${{ inputs.nifi-username }}
        NIFI_PASSWORD: ${{ inputs.nifi-password }}
        NIFI_BEARER_TOKEN: ${{ inputs.nifi-bearer-token }}
        NIFI_VERIFY_SSL: ${{ inputs.nifi-verify-ssl }}
        GH_REGISTRY_TOKEN: ${{ inputs.registry-token }}
        NIFI_REGISTRY_REPO: ${{ inputs.registry-repo || github.repository }}
        NIFI_REGISTRY_CLIENT_NAME: ${{ inputs.registry-client-name }}
        NIFI_REGISTRY_CLIENT_ID: ${{ inputs.registry-client-id }}
        NIFI_REPOSITORY_PATH: ${{ inputs.repository-path }}
        NIFI_BUCKET: ${{ inputs.bucket }}
        NIFI_FLOW: ${{ inputs.flow }}
        NIFI_FLOW_BRANCH: ${{ inputs.branch }}
        NIFI_TARGET_VERSION: ${{ inputs.version }}
        NIFI_PROCESS_GROUP_ID: ${{ inputs.process-group-id }}
        NIFI_PARAMETERS: ${{ inputs.parameters }}
        NIFI_LOG_LEVEL: ${{ inputs.log-level }}
        # Stop/Cleanup options
        NIFI_DISABLE_CONTROLLERS: ${{ inputs.disable-controllers }}
        NIFI_DELETE_PARAMETER_CONTEXT: ${{ inputs.delete-parameter-context }}
        NIFI_FORCE_DELETE: ${{ inputs.force }}
      run: |
        set -e

        # Map command names to CLI function names
        case "${{ inputs.command }}" in
          ensure-registry)  CMD="ensure_registry" ;;
          deploy-flow)      CMD="deploy_flow" ;;
          start-flow)       CMD="start_flow" ;;
          stop-flow)        CMD="stop_flow" ;;
          get-status)       CMD="get_status" ;;
          configure-params) CMD="configure_params" ;;
          change-version)   CMD="change_version" ;;
          revert-flow)      CMD="revert_flow" ;;
          cleanup)          CMD="cleanup" ;;
          purge-flowfiles)  CMD="purge_flowfiles" ;;
          *)
            echo "Unknown command: ${{ inputs.command }}"
            exit 1
            ;;
        esac

        echo "Running: nipyapi ci $CMD"

        # Run the CLI command - it auto-detects GitHub Actions and outputs in github format
        # CLI uses heredoc syntax for multiline values (like logs)
        OUTPUT=$(nipyapi ci $CMD 2>&1) || {
          echo "Command failed:"
          echo "$OUTPUT"
          exit 1
        }

        # Write outputs to GITHUB_OUTPUT
        echo "$OUTPUT" >> $GITHUB_OUTPUT
        echo "success=true" >> $GITHUB_OUTPUT

        # Show summary to console
        echo "$OUTPUT"

branding:
  icon: 'database'
  color: 'blue'
