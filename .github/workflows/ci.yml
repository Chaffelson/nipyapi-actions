name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test-actions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout nipyapi-actions
        uses: actions/checkout@v4

      - name: Checkout nipyapi (for infrastructure)
        uses: actions/checkout@v4
        with:
          repository: Chaffelson/nipyapi
          ref: feature/github-cicd-versioning
          path: nipyapi-infra

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install action dependencies
        run: pip install -r requirements.txt

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate certificates
        run: cd nipyapi-infra && make certs

      - name: Start NiFi infrastructure
        run: cd nipyapi-infra && make up NIPYAPI_PROFILE=github-cicd

      - name: Wait for NiFi to be ready
        run: cd nipyapi-infra && make wait-ready NIPYAPI_PROFILE=github-cicd

      # Test: Ensure Registry Client
      # Note: PAT required - GITHUB_TOKEN doesn't work with NiFi's GitHub Flow Registry Client
      - name: Test ensure-registry
        uses: ./
        id: registry
        with:
          command: ensure-registry
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          github-registry-token: ${{ secrets.GH_REGISTRY_TOKEN }}
          github-registry-repo: ${{ github.repository }}
          registry-client-name: 'ci-test-registry'
          repository-path: 'tests'

      - name: Verify registry output
        run: |
          echo "Registry Client ID: ${{ steps.registry.outputs.registry-client-id }}"
          if [ -z "${{ steps.registry.outputs.registry-client-id }}" ]; then
            echo "ERROR: registry-client-id not set"
            exit 1
          fi

      # Test: Deploy Flow
      - name: Test deploy-flow
        uses: ./
        id: deploy
        with:
          command: deploy-flow
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          registry-client-id: ${{ steps.registry.outputs.registry-client-id }}
          bucket: flows
          flow: cicd-demo-flow

      - name: Verify deploy output
        run: |
          echo "Process Group ID: ${{ steps.deploy.outputs.process-group-id }}"
          echo "Deployed Version: ${{ steps.deploy.outputs.deployed-version }}"
          if [ -z "${{ steps.deploy.outputs.process-group-id }}" ]; then
            echo "ERROR: process-group-id not set"
            exit 1
          fi

      # Test: Start Flow
      - name: Test start-flow
        uses: ./
        id: start
        with:
          command: start-flow
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          enable-controllers: 'true'

      - name: Verify flow started
        run: |
          echo "Flow started: ${{ steps.start.outputs.started }}"

      # Test: Get Status
      - name: Test get-status
        uses: ./
        id: status
        with:
          command: get-status
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Verify status output
        run: |
          echo "State: ${{ steps.status.outputs.state }}"
          echo "Running Processors: ${{ steps.status.outputs.running-processors }}"
          echo "Enabled Controllers: ${{ steps.status.outputs.enabled-controllers }}"
          if [ "${{ steps.status.outputs.state }}" != "RUNNING" ]; then
            echo "WARNING: Expected RUNNING state"
          fi

      # Test: HTTP Endpoint (default version)
      - name: Test HTTP endpoint (default version)
        run: |
          echo "Testing HTTP endpoint..."
          sleep 2
          HTTP_RESPONSE=$(curl -s -i http://localhost:8080/version 2>/dev/null || echo "FAILED")
          echo "$HTTP_RESPONSE"
          VERSION=$(echo "$HTTP_RESPONSE" | grep -i "^version:" | cut -d' ' -f2 | tr -d '\r')
          echo "Version header: [$VERSION]"
          if [ "$VERSION" = "1.0.0" ]; then
            echo "SUCCESS: Default version is 1.0.0"
          else
            echo "WARNING: Expected 1.0.0, got $VERSION"
          fi

      # Test: Configure Parameters (Secret Injection)
      # This tests that dynamic values (like secrets) are correctly injected into parameters.
      # We use github.run_id as a predictable "secret" that we can verify was correctly set.
      - name: Test configure-params (secret injection)
        uses: ./
        id: params
        with:
          command: configure-params
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          parameters: '{"version": "${{ github.run_id }}"}'

      - name: Verify parameters updated
        run: |
          echo "Parameters Updated: ${{ steps.params.outputs.parameters-updated }}"
          echo "Injected Value: ${{ github.run_id }}"
          echo "Success: ${{ steps.params.outputs.success }}"

      # Test: HTTP Endpoint (verify secret injection)
      # Verifies the injected value (github.run_id) is returned by the flow
      - name: Test HTTP endpoint (verify secret injection)
        env:
          EXPECTED_VALUE: ${{ github.run_id }}
        run: |
          echo "Testing HTTP endpoint after parameter injection..."
          echo "Expected value: $EXPECTED_VALUE"
          sleep 2
          HTTP_RESPONSE=$(curl -s -i http://localhost:8080/version 2>/dev/null || echo "FAILED")
          echo "$HTTP_RESPONSE"
          VERSION=$(echo "$HTTP_RESPONSE" | grep -i "^version:" | cut -d' ' -f2 | tr -d '\r')
          echo "Version header: [$VERSION]"
          if [ "$VERSION" = "$EXPECTED_VALUE" ]; then
            echo "SUCCESS: Secret injection verified - value correctly passed through"
          else
            echo "ERROR: Expected $EXPECTED_VALUE, got $VERSION"
            exit 1
          fi

      # Test: Change Version (to older version v1.0.0)
      - name: Test change-version (to v1.0.0)
        uses: ./
        id: change-version
        with:
          command: change-version
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          target-version: 'v1.0.0'
          github-registry-token: ${{ secrets.GH_REGISTRY_TOKEN }}

      - name: Verify version changed
        run: |
          echo "Previous Version: ${{ steps.change-version.outputs.previous-version }}"
          echo "New Version: ${{ steps.change-version.outputs.new-version }}"
          # v1.0.0 tag resolves to this SHA
          if [[ "${{ steps.change-version.outputs.new-version }}" == "97549b88f2e1fb1dccddef57335e94628c74060b" ]]; then
            echo "SUCCESS: Version changed to v1.0.0"
          else
            echo "ERROR: Expected v1.0.0 SHA, got ${{ steps.change-version.outputs.new-version }}"
            exit 1
          fi

      # Test: Change Version (back to latest)
      - name: Test change-version (to latest)
        uses: ./
        id: change-latest
        with:
          command: change-version
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          github-registry-token: ${{ secrets.GH_REGISTRY_TOKEN }}
          # No target-version means latest

      - name: Verify changed to latest
        run: |
          echo "Previous Version: ${{ steps.change-latest.outputs.previous-version }}"
          echo "New Version: ${{ steps.change-latest.outputs.new-version }}"
          # Verify previous was v1.0.0 and new is different (i.e., latest)
          if [[ "${{ steps.change-latest.outputs.previous-version }}" != "97549b88f2e1fb1dccddef57335e94628c74060b" ]]; then
            echo "ERROR: Previous version should be v1.0.0 SHA"
            exit 1
          fi
          if [[ "${{ steps.change-latest.outputs.new-version }}" == "${{ steps.change-latest.outputs.previous-version }}" ]]; then
            echo "ERROR: Version did not change"
            exit 1
          fi
          echo "SUCCESS: Changed from v1.0.0 to latest (${{ steps.change-latest.outputs.new-version }})"

      # Test: Revert Flow (after making structural modification)
      # Parameter changes don't trigger LOCALLY_MODIFIED - must make structural change
      - name: Create structural modification for revert test
        env:
          NIFI_API_ENDPOINT: https://localhost:9447/nifi-api
          NIFI_USERNAME: einstein
          NIFI_PASSWORD: password1234
          NIFI_VERIFY_SSL: 'false'
        run: |
          python -c "
          import sys; sys.path.insert(0, 'src')
          from nipyapi import profiles; profiles.switch('env')
          from utils import modify_processor
          modify_processor('${{ steps.deploy.outputs.process-group-id }}')
          "

      - name: Verify LOCALLY_MODIFIED state via get-status
        uses: ./
        id: status-modified
        with:
          command: get-status
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Check state is LOCALLY_MODIFIED
        run: |
          echo "Version state: ${{ steps.status-modified.outputs.version-state }}"
          if [ "${{ steps.status-modified.outputs.version-state }}" != "LOCALLY_MODIFIED" ]; then
            echo "ERROR: Expected LOCALLY_MODIFIED, got ${{ steps.status-modified.outputs.version-state }}"
            exit 1
          fi
          echo "SUCCESS: Flow is LOCALLY_MODIFIED"

      - name: Test revert-flow
        uses: ./
        id: revert
        with:
          command: revert-flow
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Verify revert
        run: |
          echo "Reverted: ${{ steps.revert.outputs.reverted }}"
          echo "State: ${{ steps.revert.outputs.state }}"
          if [ "${{ steps.revert.outputs.state }}" = "UP_TO_DATE" ]; then
            echo "SUCCESS: Flow reverted to UP_TO_DATE state"
          else
            echo "ERROR: Expected UP_TO_DATE state, got ${{ steps.revert.outputs.state }}"
            exit 1
          fi

      # Test: Stop Flow
      - name: Test stop-flow
        uses: ./
        id: stop
        with:
          command: stop-flow
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          disable-controllers: 'true'

      - name: Verify flow stopped
        run: |
          echo "Flow stopped: ${{ steps.stop.outputs.stopped }}"

      # Test: Cleanup
      - name: Test cleanup
        if: always()
        uses: ./
        id: cleanup
        with:
          command: cleanup
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          force-delete: 'true'
          delete-parameter-context: 'true'

      - name: Verify cleanup
        if: always()
        run: |
          echo "Deleted: ${{ steps.cleanup.outputs.deleted }}"
          echo "Deleted Name: ${{ steps.cleanup.outputs.deleted-name }}"

      # Summary
      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "============================================"
          echo "CI TEST SUMMARY"
          echo "============================================"
          echo "Registry Client: ${{ steps.registry.outputs.registry-client-name }} (${{ steps.registry.outputs.registry-client-id }})"
          echo "Process Group: ${{ steps.deploy.outputs.process-group-name }} (${{ steps.deploy.outputs.process-group-id }})"
          echo "Deployed Version: ${{ steps.deploy.outputs.deployed-version }}"
          echo "Final State: ${{ steps.status.outputs.state }}"
          echo "Cleanup Status: ${{ steps.cleanup.outputs.deleted }}"
          echo "============================================"

      # Cleanup infrastructure
      - name: Stop NiFi infrastructure
        if: always()
        run: cd nipyapi-infra && make down
