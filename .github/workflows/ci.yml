name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test-actions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout nipyapi-actions
        uses: actions/checkout@v4

      - name: Checkout nipyapi (for infrastructure)
        uses: actions/checkout@v4
        with:
          repository: Chaffelson/nipyapi
          ref: main
          path: nipyapi-infra

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install action dependencies
        run: pip install -r requirements.txt

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate certificates
        run: cd nipyapi-infra && make certs

      - name: Start NiFi infrastructure
        run: cd nipyapi-infra && make up NIPYAPI_PROFILE=github-cicd

      - name: Wait for NiFi to be ready
        run: cd nipyapi-infra && make wait-ready NIPYAPI_PROFILE=github-cicd

      # Test: Ensure Registry Client
      # Note: PAT required - GITHUB_TOKEN doesn't work with NiFi's GitHub Flow Registry Client
      - name: Test ensure-registry
        uses: ./
        id: registry
        with:
          command: ensure-registry
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          registry-token: ${{ secrets.GH_REGISTRY_TOKEN }}
          registry-repo: ${{ github.repository }}
          registry-client-name: 'ci-test-registry'
          repository-path: 'tests'

      - name: Verify registry output
        run: |
          echo "Registry Client ID: ${{ steps.registry.outputs.registry-client-id }}"
          if [ -z "${{ steps.registry.outputs.registry-client-id }}" ]; then
            echo "ERROR: registry-client-id not set"
            exit 1
          fi

      # Test: List Registry Flows
      - name: Test list-registry-flows
        uses: ./
        id: list-flows
        with:
          command: list-registry-flows
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          registry-client-id: ${{ steps.registry.outputs.registry-client-id }}
          bucket: flows

      - name: Verify list-registry-flows output
        run: |
          echo "Flow count: ${{ steps.list-flows.outputs.flow-count }}"
          echo "Flows: ${{ steps.list-flows.outputs.flows }}"
          if [ -z "${{ steps.list-flows.outputs.flow-count }}" ] || [ "${{ steps.list-flows.outputs.flow-count }}" = "0" ]; then
            echo "ERROR: Expected at least one flow"
            exit 1
          fi
          echo "SUCCESS: Found ${{ steps.list-flows.outputs.flow-count }} flow(s)"

      # Test: Deploy Flow
      - name: Test deploy-flow
        uses: ./
        id: deploy
        with:
          command: deploy-flow
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          registry-client-id: ${{ steps.registry.outputs.registry-client-id }}
          bucket: flows
          flow: nipyapi_test_cicd_demo

      - name: Verify deploy output
        run: |
          echo "Process Group ID: ${{ steps.deploy.outputs.process-group-id }}"
          echo "Deployed Version: ${{ steps.deploy.outputs.deployed-version }}"
          if [ -z "${{ steps.deploy.outputs.process-group-id }}" ]; then
            echo "ERROR: process-group-id not set"
            exit 1
          fi

      # Test: Get Versions
      - name: Test get-versions
        uses: ./
        id: versions
        with:
          command: get-versions
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Verify get-versions output
        run: |
          echo "Current Version: ${{ steps.versions.outputs.current-version }}"
          echo "Version Count: ${{ steps.versions.outputs.version-count }}"
          echo "Flow ID: ${{ steps.versions.outputs.flow-id }}"
          if [ -z "${{ steps.versions.outputs.version-count }}" ] || [ "${{ steps.versions.outputs.version-count }}" = "0" ]; then
            echo "ERROR: Expected at least one version"
            exit 1
          fi
          echo "SUCCESS: Found ${{ steps.versions.outputs.version-count }} version(s)"

      # Test: Get Diff (should be UP_TO_DATE after fresh deploy)
      - name: Test get-diff (clean state)
        uses: ./
        id: diff
        with:
          command: get-diff
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Verify get-diff output
        run: |
          echo "State: ${{ steps.diff.outputs.state }}"
          echo "Modification Count: ${{ steps.diff.outputs.modification-count }}"
          if [ "${{ steps.diff.outputs.state }}" != "UP_TO_DATE" ]; then
            echo "ERROR: Expected UP_TO_DATE state after fresh deploy"
            exit 1
          fi
          if [ "${{ steps.diff.outputs.modification-count }}" != "0" ]; then
            echo "ERROR: Expected 0 modifications after fresh deploy"
            exit 1
          fi
          echo "SUCCESS: Flow is UP_TO_DATE with 0 modifications"

      # Test: Start Flow
      - name: Test start-flow
        uses: ./
        id: start
        with:
          command: start-flow
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Verify flow started
        run: |
          echo "Flow started: ${{ steps.start.outputs.started }}"

      # Test: Get Status
      - name: Test get-status
        uses: ./
        id: status
        with:
          command: get-status
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Verify status output
        run: |
          echo "State: ${{ steps.status.outputs.state }}"
          echo "Running Processors: ${{ steps.status.outputs.running-processors }}"
          echo "Enabled Controllers: ${{ steps.status.outputs.enabled-controllers }}"
          if [ "${{ steps.status.outputs.state }}" != "RUNNING" ]; then
            echo "WARNING: Expected RUNNING state"
          fi

      # Test: HTTP Endpoint (default version)
      - name: Test HTTP endpoint (default version)
        run: |
          echo "Testing HTTP endpoint..."
          sleep 2
          HTTP_RESPONSE=$(curl -s -i http://localhost:8080/version 2>/dev/null || echo "FAILED")
          echo "$HTTP_RESPONSE"
          VERSION=$(echo "$HTTP_RESPONSE" | grep -i "^version:" | cut -d' ' -f2 | tr -d '\r')
          echo "Version header: [$VERSION]"
          if [ "$VERSION" = "1.0.0" ]; then
            echo "SUCCESS: Default version is 1.0.0"
          else
            echo "WARNING: Expected 1.0.0, got $VERSION"
          fi

      # Test: Configure Parameters (Secret Injection)
      # This tests that dynamic values (like secrets) are correctly injected into parameters.
      # We use github.run_id as a predictable "secret" that we can verify was correctly set.
      - name: Test configure-params (secret injection)
        uses: ./
        id: params
        with:
          command: configure-params
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          parameters: '{"version": "${{ github.run_id }}"}'

      - name: Verify parameters updated
        run: |
          echo "Parameters Updated: ${{ steps.params.outputs.parameters-updated }}"
          echo "Injected Value: ${{ github.run_id }}"
          echo "Success: ${{ steps.params.outputs.success }}"

      # Test: HTTP Endpoint (verify secret injection)
      # Verifies the injected value (github.run_id) is returned by the flow
      - name: Test HTTP endpoint (verify secret injection)
        env:
          EXPECTED_VALUE: ${{ github.run_id }}
        run: |
          echo "Testing HTTP endpoint after parameter injection..."
          echo "Expected value: $EXPECTED_VALUE"
          sleep 2
          HTTP_RESPONSE=$(curl -s -i http://localhost:8080/version 2>/dev/null || echo "FAILED")
          echo "$HTTP_RESPONSE"
          VERSION=$(echo "$HTTP_RESPONSE" | grep -i "^version:" | cut -d' ' -f2 | tr -d '\r')
          echo "Version header: [$VERSION]"
          if [ "$VERSION" = "$EXPECTED_VALUE" ]; then
            echo "SUCCESS: Secret injection verified - value correctly passed through"
          else
            echo "ERROR: Expected $EXPECTED_VALUE, got $VERSION"
            exit 1
          fi

      # Test: Change Version (to older version v1.0.0 tag)
      - name: Test change-version (to v1.0.0)
        uses: ./
        id: change-version
        with:
          command: change-version
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          version: 'v1.0.0'
          registry-token: ${{ secrets.GH_REGISTRY_TOKEN }}

      - name: Verify version changed
        run: |
          echo "Previous Version: ${{ steps.change-version.outputs.previous-version }}"
          echo "New Version: ${{ steps.change-version.outputs.new-version }}"
          # Verify version changed
          if [[ -z "${{ steps.change-version.outputs.new-version }}" ]]; then
            echo "ERROR: new-version output is empty"
            exit 1
          fi
          if [[ "${{ steps.change-version.outputs.new-version }}" != "${{ steps.change-version.outputs.previous-version }}" ]]; then
            echo "SUCCESS: Version changed from previous to v1.0.0"
          else
            echo "ERROR: Version did not change"
            exit 1
          fi

      # Test: Change Version (back to latest)
      - name: Test change-version (to latest)
        uses: ./
        id: change-latest
        with:
          command: change-version
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          registry-token: ${{ secrets.GH_REGISTRY_TOKEN }}
          # No target-version means latest

      - name: Verify changed to latest
        run: |
          echo "Previous Version: ${{ steps.change-latest.outputs.previous-version }}"
          echo "New Version: ${{ steps.change-latest.outputs.new-version }}"
          # Verify version changed (previous was v1.0.0, now is latest)
          if [[ -z "${{ steps.change-latest.outputs.new-version }}" ]]; then
            echo "ERROR: new-version output is empty"
            exit 1
          fi
          if [[ "${{ steps.change-latest.outputs.new-version }}" == "${{ steps.change-latest.outputs.previous-version }}" ]]; then
            echo "ERROR: Version did not change from v1.0.0 to latest"
            exit 1
          fi
          echo "SUCCESS: Changed from v1.0.0 to latest (${{ steps.change-latest.outputs.new-version }})"

      # Test: Revert Flow (after making structural modification)
      # Parameter changes don't trigger LOCALLY_MODIFIED - must make structural change
      - name: Create structural modification for revert test
        env:
          NIFI_API_ENDPOINT: https://localhost:9447/nifi-api
          NIFI_USERNAME: einstein
          NIFI_PASSWORD: password1234
          NIFI_VERIFY_SSL: 'false'
        run: |
          python -c "
          import nipyapi
          nipyapi.profiles.switch('env')
          processors = nipyapi.canvas.list_all_processors('${{ steps.deploy.outputs.process-group-id }}')
          p = processors[0]
          nipyapi.canvas.update_processor(p, name=p.component.name + '-modified', auto_stop=True)
          print('Modified processor:', p.component.name)
          "

      - name: Verify LOCALLY_MODIFIED state via get-status
        uses: ./
        id: status-modified
        with:
          command: get-status
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Check state is LOCALLY_MODIFIED
        run: |
          echo "Version state: ${{ steps.status-modified.outputs.version-state }}"
          if [ "${{ steps.status-modified.outputs.version-state }}" != "LOCALLY_MODIFIED" ]; then
            echo "ERROR: Expected LOCALLY_MODIFIED, got ${{ steps.status-modified.outputs.version-state }}"
            exit 1
          fi
          echo "SUCCESS: Flow is LOCALLY_MODIFIED"

      # Test: Get Diff (should show modifications after structural change)
      - name: Test get-diff (with modifications)
        uses: ./
        id: diff-modified
        with:
          command: get-diff
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Verify get-diff detects modifications
        run: |
          echo "State: ${{ steps.diff-modified.outputs.state }}"
          echo "Modification Count: ${{ steps.diff-modified.outputs.modification-count }}"
          if [ "${{ steps.diff-modified.outputs.state }}" != "LOCALLY_MODIFIED" ]; then
            echo "ERROR: Expected LOCALLY_MODIFIED state"
            exit 1
          fi
          if [ "${{ steps.diff-modified.outputs.modification-count }}" = "0" ]; then
            echo "ERROR: Expected modifications to be detected"
            exit 1
          fi
          echo "SUCCESS: get-diff detected ${{ steps.diff-modified.outputs.modification-count }} modification(s)"

      - name: Test revert-flow
        uses: ./
        id: revert
        with:
          command: revert-flow
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Verify revert
        run: |
          echo "Reverted: ${{ steps.revert.outputs.reverted }}"
          echo "State: ${{ steps.revert.outputs.state }}"
          if [ "${{ steps.revert.outputs.state }}" = "UP_TO_DATE" ]; then
            echo "SUCCESS: Flow reverted to UP_TO_DATE state"
          else
            echo "ERROR: Expected UP_TO_DATE state, got ${{ steps.revert.outputs.state }}"
            exit 1
          fi

      # Test: Stop Flow
      - name: Test stop-flow
        uses: ./
        id: stop
        with:
          command: stop-flow
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          disable-controllers: 'true'

      - name: Verify flow stopped
        run: |
          echo "Flow stopped: ${{ steps.stop.outputs.stopped }}"

      # Test: Purge FlowFiles
      - name: Test purge-flowfiles
        uses: ./
        id: purge
        with:
          command: purge-flowfiles
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}

      - name: Verify purge
        run: |
          echo "Purged: ${{ steps.purge.outputs.purged }}"
          echo "Connections purged: ${{ steps.purge.outputs.connections-purged }}"
          if [ "${{ steps.purge.outputs.purged }}" != "true" ]; then
            echo "ERROR: Expected purged=true"
            exit 1
          fi

      # Test: Cleanup
      - name: Test cleanup
        if: always()
        uses: ./
        id: cleanup
        with:
          command: cleanup
          nifi-api-endpoint: https://localhost:9447/nifi-api
          nifi-username: einstein
          nifi-password: password1234
          nifi-verify-ssl: 'false'
          process-group-id: ${{ steps.deploy.outputs.process-group-id }}
          force: 'true'
          delete-parameter-context: 'true'

      - name: Verify cleanup
        if: always()
        run: |
          echo "Deleted: ${{ steps.cleanup.outputs.deleted }}"
          echo "Deleted Name: ${{ steps.cleanup.outputs.deleted-name }}"

      # Summary
      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "============================================"
          echo "CI TEST SUMMARY"
          echo "============================================"
          echo "Registry Client: ${{ steps.registry.outputs.registry-client-name }} (${{ steps.registry.outputs.registry-client-id }})"
          echo "Process Group: ${{ steps.deploy.outputs.process-group-name }} (${{ steps.deploy.outputs.process-group-id }})"
          echo "Deployed Version: ${{ steps.deploy.outputs.deployed-version }}"
          echo "Final State: ${{ steps.status.outputs.state }}"
          echo "Cleanup Status: ${{ steps.cleanup.outputs.deleted }}"
          echo "============================================"

      # Cleanup infrastructure
      - name: Stop NiFi infrastructure
        if: always()
        run: cd nipyapi-infra && make down
